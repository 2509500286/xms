@model Xms.Web.Customize.Models.SolutionComponentModel
@{
    Layout = null;
}
@{
    Xms.Web.Models.DialogModel dialogModel = ViewData["DialogModel"] as Xms.Web.Models.DialogModel;
}
<!-- （Modal） -->

<div class="modal fade" id="solutionComponentModal" tabindex="-1" role="dialog"
     aria-labelledby="solutionComponentModalLabel" aria-hidden="true">

    <link href="~/content/js/jquery-ui-1.10.3/themes/base/jquery.ui.all.css?v=@app.PlatformSettings.VersionNumber" rel="stylesheet">
    <link href="~/content/js/grid/pqgrid.dev.css?v=@app.PlatformSettings.VersionNumber" rel="stylesheet">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal"
                        aria-hidden="true">
                    ×
                </button>
                <h4 class="modal-title" id="solutionComponentModalLabel">
                    <span class="glyphicon glyphicon-th"></span> 组件
                </h4>
            </div>
            <div class="modal-body">
                <div class="dialog-datagrid-view" id="datagriddialogview"></div>
                @*<div class="table-responsive" id="gridview">
                    <table class="table table-striped table-hover table-condensed datatableload" id="datatable" data-ajax="true" data-ajaxcontainer="gridview" data-ajaxcallback="SolutionComponentModel.ajaxgrid_reset()" data-sortby="@Model.SortBy.ToLower()" data-sortdirection="@Model.SortDirection" data-singlemode="@dialogModel.SingleMode">
                        <thead>
                            <tr>
                                <th width="2%"><input type="checkbox" name="checkall" /></th>
                                <th data-name="name">
                                    名称
                                </th>
                                <th data-name="localizedname">
                                    显示名称
                                </th>
                                <th data-name="componenttypename">
                                    类型
                                </th>
                                <th width="2%">
                                    选择
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var item in Model.Items)
                            {
                                <tr>
                                    <td><input type="checkbox" value="@item.ObjectId" name="recordid" /></td>
                                    <td>@item.Name</td>
                                    <td>@item.LocalizedName</td>
                                    <td>@item.ComponentTypeName</td>
                                    <td>
                                        <a class="btn btn-link btn-xs" onclick="Xms.Web.SelectingRow(this);SolutionComponentModel.dialog_return();"><span class="glyphicon glyphicon-ok"></span></a>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="panel-footer">
                        <div class="row">
                            <div class="col-sm-4">@("当前" + @Model.Page + "/" + @Model.TotalPages + "页, 共" + @Model.TotalItems + "行记录")</div>
                            <div id="page-selection-Dialog" class="col-sm-8 " data-total="@Model.TotalPages" data-page="@Model.Page">
                            </div>
                        </div>
                    </div>

                </div>*@
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default"
                        data-dismiss="modal">
                    <span class="glyphicon glyphicon-remove"></span> 关闭
                </button>
                <button type="button" class="btn btn-primary" onclick="SolutionComponentModel.dialog_return()">
                    <span class="glyphicon glyphicon-ok"></span> 确定
                </button>
            </div>
            <script src="/content/js/jquery-ui-1.10.3/ui/jquery.ui.button.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/jquery-ui-1.10.3/ui/jquery.ui.mouse.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/jquery-ui-1.10.3/ui/jquery.ui.autocomplete.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/jquery-ui-1.10.3/ui/jquery.ui.draggable.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/jquery-ui-1.10.3/ui/jquery.ui.resizable.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/jquery-ui-1.10.3/ui/jquery.ui.tooltip.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/grid/pqgrid.dev.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/grid/localize/pq-localize-zh.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/Content/js/cdatagrid.js?v=@app.PlatformSettings.VersionNumber"></script>

            <script src="/content/js/jquery.bootpag.min.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script src="/content/js/jquery.form.js?v=@app.PlatformSettings.VersionNumber"></script>
            <script>
                        var SolutionComponentModel = {
                            dialogid: '#solutionComponentModal',
                            dialog: $('#solutionComponentModal'),
                            datatable: $("#solutionComponentModal .datatableload"),
                            gridviewid: "#solutionComponentModal #gridview",
                            gridview: $("#solutionComponentModal #gridview"),
                            searchform: $('#solutionComponentModal #searchForm'),
                            pagesection: $('#page-selection-Dialog'),
                            pageUrl : '@app.Url',
                            callback : @dialogModel.CallBack,
                            inputid : '@dialogModel.InputId',
                            solutionid: '@Model.SolutionId',
                            serviceuri: '@Model.ComponentDescriptor.ComponentsEndpoint',
                            ajaxgrid_reset : function () {
                                SolutionComponentModel.pag_init();
                                Xms.Web.DataTable($("#solutionComponentModal .datatableload"));
                            },
                            pag_init: function () {
                                var page_section = $('#page-selection-Dialog');
                                page_section.bootpag({
                                    total: page_section.attr('data-total')
                                    , maxVisible: 5
                                    , page: page_section.attr('data-page')
                                    , leaps: false
                                    , prev: '&lsaquo;'
                                    , next: '&rsaquo;'
                                    , firstLastUse: true
                                    , first: '&laquo;'
                                    , last: '&raquo;'
                                }).on("page", function (event, /* page number here */ num) {
                                    event.preventDefault();
                                    var url = $.setUrlParam(SolutionComponentModel.pageUrl, 'page', num);
                                    SolutionComponentModel.gridview.ajaxLoad(url, SolutionComponentModel.gridviewid, function (response) {
                                        SolutionComponentModel.ajaxgrid_reset();
                                    });
                                    return false;
                                });
                            },
                            dialog_return : function () {
                                var result = new Array();
                                //$("#solutionComponentModal .datatableload").find("input[name=recordid]:checked").each(function (i, n) {
                                //    var obj = new Object();
                                //    obj.id = $(n).val();
                                //    $("#solutionComponentModal .datatableload").find('thead>tr>th[data-name]').each(function(i, nn){
                                //        var idx = $(nn).index();
                                //        var value = $(n).parents('tr:first').find('td:eq('+idx+')').text();
                                //        eval('obj.' + $(nn).attr('data-name') + '="' + value + '"');
                                //    });
                                //    //obj.name = $(n).parents('tr:first').find('td:eq('+idx+')').text();
                                //    result.push(obj);
                                //});

                                var $datagriddialogview = $('#datagriddialogview');
                                var $Grid = $datagriddialogview.cDatagrid('getGrid');
                                $datagriddialogview.find("input[name=recordid]:checked").each(function (i, n) {
                                    var obj = new Object();
                                    obj.id = $(n).val();
                                    var data = $Grid.pqGrid('getRowData',{ rowIndxPage: i })
                                    //$("#solutionComponentModal .datatableload").find('thead>tr>th[data-name]').each(function (i, nn) {
                                    //    var idx = $(nn).index();
                                    //    var value = $(n).parents('tr:first').find('td:eq(' + idx + ')').text();
                                    //    eval('obj.' + $(nn).attr('data-name') + '="' + value + '"');
                                    //});
                                    //obj.name = $(n).parents('tr:first').find('td:eq('+idx+')').text();
                                    obj.name = data.localizedname;
                                    result.push(obj);
                                });
                                SolutionComponentModel.callback(result,SolutionComponentModel.inputid);
                                SolutionComponentModel.dialog.modal('hide');
                            }
                        };

                        $(function () {
                            SolutionComponentModel.ajaxgrid_reset();
                            SolutionComponentModel.searchform.ajaxSearch(SolutionComponentModel.gridviewid, SolutionComponentModel.ajaxgrid_reset);
                            SolutionComponentModel.datatable.ajaxTable();
                            SolutionComponentModel.dialog.modal({
                                backdrop: 'static'
                            });
                            SolutionComponentModel.dialog.on('hidden.bs.modal', function () {
                                Xms.Web.CloseDialog(SolutionComponentModel.dialogid);
                            });
                            $(SolutionComponentModel.dialogid + ' button[name=createBtn]').off('click').on('click', null, function (e) {
                                SolutionComponentModel.CreateRecord();
                            });
                            //Xms.Ajax.GetJson(SolutionComponentModel.serviceuri + '?page=1&pagesize=10&insolution=false&solutionid=' + SolutionComponentModel.solutionid, null, function (response) {
                            //    console.log('components', response);
                            //});
                            //"{"currentpage":1,"items":[{"objectid":"4cdb41ab-cc63-4b86-b611-9b8b457bb6cb","name":"Customer.js","localizedname":"Customer.js","componenttypename":"WebResource"}],"itemsperpage":10,"totalitems":1,"totalpages":1}"

                            var columnConfigs = [{ "dataIndx": "name", "title": "名称", "dataType": "string", "width": 100 , "isrequired": true, "isloged": false, "iscustomfield": false, "iscustomizable": false, "issecured": false, "isprimaryfield": false,  "attributetypename": "string" },
                                { "dataIndx": "localizedname", "title": "显示名称", "dataType": "string", "width": 100 , "isrequired": true,  "isprimaryfield": false, "attributetypename": "string" },
                                { "dataIndx": "componenttypename", "title": "类型", "dataType": "string", "width": 100,  "isrequired": true, "isprimaryfield": false, "attributetypename": "string" },
                            {
                                title: "选择", editable: false, minWidth: 165, sortable: false, render: function (ui) {
                                    return '<a class="btn btn-link btn-xs rowclickok" href="javascript:;" ><span class="glyphicon glyphicon-ok"></span></a>';
                                }
                            }]
                          
                            var datagridconfig = {
                               //获取数据的方法
                                getDataUrl: function () {
                                    return ORG_SERVERURL+SolutionComponentModel.serviceuri + '?page=1&pagesize=10&insolution=false&solutionid=' + SolutionComponentModel.solutionid
                                },
                                headerFilter: true,
                                pageModel: { type: "remote", rPP: 10, page: 1, strRpp: "{0}" },
                                //itemsBtnTmpl: itemtmpl,
                                filterColModel: function (opts) { opts.colModel = columnConfigs; return opts; },
                                rowDblClick: function (event, ui) {
                                    console.log($(event.target));
                                    console.log(ui);
                                    var $tr = ui.$tr;
                                    $tr.find('input[name="recordid"]').prop('checked', true);
                                    SolutionComponentModel.dialog_return();
                                },
                                columnFilter: function (items) {
                                    console.log(items)

                                    $.each(items, function (key, item) {
                                        item.editable = false;

                                    });
                                    //添加操作列
                                    items.unshift(
                                        {
                                            title: "", dataIndx: "recordid", maxWidth: 30, minWidth: 30, align: "center", resizable: false,
                                            type: 'checkBoxSelection', cls: 'ui-state-default', sortable: false, editable: false,
                                            render: function (ui) {
                                                console.log(ui)
                                                return '<input type="checkbox" value="' + ui.rowData.objectid+'" name="recordid" class="">'
                                            },
                                            cb: { all: true, header: true }
                                        });
                                    return items;
                                }
                            }
                            datagridconfig.extend = function (datagrid) {
                                var filter = function (postData, objP) {
                                    $.extend(postData, { sortby: objP.dataIndx, sortdirection: objP.dir == 'up' ? '0' : '1' });
                                    return postData;
                                }


                                $.extend(datagrid.opts.dataModel, {
                                    filterSendData: filter,
                                    method: 'GET',
                                    dataType:'json',
                                    getData: function (dataJSON, textStatus, jqXHR) {
                                        if (typeof dataJSON.Content == 'string') {
                                            dataContent = JSON.parse(dataJSON.Content);
                                        }
                                        var data = dataContent.items;
                                        var res = { curPage: dataContent.currentpage || 1, totalRecords: dataContent.totalitems, data: data }
                                        console.log(res);
                                        return res;
                                    }
                                })
                            }

                          //  console.log(itemtmpl);
                            $('.dialog-datagrid-view').cDatagrid(datagridconfig);

                            $('.dialog-datagrid-view').off('click').on('click', '.rowclickok', function (e) {
                                var $tr = $(this).parents('tr:first');
                                $tr.find('input[name="recordid"]').prop('checked', true);
                                SolutionComponentModel.dialog_return();
                            });
                        });
            </script>
        </div><!-- /.modal-content -->
    </div><!-- /.modal-dialog -->
</div><!-- /.modal -->